<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            /* ‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ responsive */
            aspect-ratio: 16 / 9;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid #00ff88;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,255,136,0.5);
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0,255,136,0.8);
        }
        
        .crosshair::before {
            top: 50%;
            left: -10px;
            right: -10px;
            height: 2px;
            transform: translateY(-50%);
        }
        
        .crosshair::after {
            left: 50%;
            top: -10px;
            bottom: -10px;
            width: 2px;
            transform: translateX(-50%);
        }
        
        .measurement-points {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff4757;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255,71,87,0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        .measurement-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #ff4757, #00ff88);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transform-origin: left center;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }

        .input, select {
            padding: 12px 14px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            outline: none;
            width: 100%;
        }
        select option { color: #111; }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00d4aa);
            color: white;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
            box-shadow: 0 4px 15px rgba(255,71,87,0.3);
        }
        
        .btn-info {
            background: linear-gradient(45deg, #3742fa, #2f3542);
            color: white;
            box-shadow: 0 4px 15px rgba(55,66,250,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mode-selector {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .mode-btn.active {
            background: rgba(255,255,255,0.2);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .results {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 500;
            opacity: 0.9;
        }
        
        .result-value {
            font-size: 18px;
            font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0,255,136,0.3);
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border-left: 4px solid #00ff88;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #00ff88;
        }
        
        .instructions ul {
            list-style: none;
            padding-left: 0;
        }
        
        .instructions li {
            padding: 5px 0;
            opacity: 0.9;
        }
        
        .instructions li::before {
            content: "üì± ";
            margin-right: 8px;
        }
        
        .camera-status {
            text-align: center;
            padding: 20px;
            color: #ff4757;
            font-weight: 500;
        }
        
        .measurement-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        /* Ruler overlay */
        .ruler-overlay {
            position: absolute;
            left: 10px;
            bottom: 10px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
        }
        .ruler-label { opacity: 0.9; }
        .ruler-bar {
            height: 8px;
            margin-top: 6px;
            background: repeating-linear-gradient(90deg, #ffffff, #ffffff 1px, transparent 1px, transparent 10px);
            border: 1px solid #ffffff;
            border-radius: 3px;
            width: 120px; /* will be overridden by JS */
            position: relative;
        }
        .ruler-bar::after {
            content: '';
            position: absolute;
            right: -1px;
            top: -4px;
            bottom: -4px;
            width: 2px;
            background: #ffffff;
        }

        .tick {
            position: absolute;
            bottom: 100%;
            width: 1px;
            background: #fff;
        }
        .tick.minor { height: 6px; opacity: 0.8; }
        .tick.major { height: 10px; }
        .tick-label {
            position: absolute;
            bottom: calc(100% + 12px);
            transform: translateX(-50%);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        }

        /* Small field label for inputs */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field-label {
            font-size: 12px;
            opacity: 0.85;
        }
        /* Hide camera selector for simpler UX */
        #cameraSelect { display: none; }
        /* Hide green center crosshair */
        .crosshair { display: none; }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .camera-container {
                aspect-ratio: 3 / 4;
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞">

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìè ‡πÅ‡∏≠‡∏õ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</h1>
            <p>‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</p>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('distance', this)">‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</button>
            <button class="mode-btn" onclick="setMode('area', this)">‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
            <button class="mode-btn" onclick="setMode('height', this)">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</button>
        </div>
        
        <div class="camera-container">
            <video id="video" autoplay playsinline webkit-playsinline></video>
            <div class="camera-overlay">
                <div class="crosshair"></div>
                <div class="measurement-points" id="points"></div>
                <div class="measurement-info" id="info">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: 0</div>
                <div class="ruler-overlay" id="rulerOverlay">
                    <div class="ruler-label" id="rulerLabel">‡∏™‡πÄ‡∏Å‡∏•: 1 ‡∏°. ‚âà 100 px</div>
                    <div class="ruler-bar" id="rulerBar"></div>
                </div>
            </div>
            <div class="camera-status" id="camera-status" style="display: none;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...
            </div>
        </div>
        
        <div class="controls">
            <select id="cameraSelect" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á" onchange="onCameraChange(this.value)"></select>
            <button class="btn btn-info" id="refreshBtn" onclick="refreshCameras()" style="display:none">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button class="btn btn-primary" onclick="addPoint()">üìç ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î</button>
            <button class="btn" onclick="undoPoint()">‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î</button>
            <button class="btn btn-secondary" onclick="clearPoints()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î</button>
            <button class="btn btn-info" onclick="calculate()">üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <button class="btn btn-info" onclick="toggleCamera()">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            <button class="btn" id="calibBtn" onclick="toggleCalibration()">üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡πÄ‡∏Å‡∏•</button>
            <div class="field">
                <label for="scaleInput" class="field-label">‡∏™‡πÄ‡∏Å‡∏• (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏ï‡πà‡∏≠ 1 ‡πÄ‡∏°‡∏ï‡∏£)</label>
                <input id="scaleInput" type="number" class="input" min="1" step="1" value="100" title="‡∏™‡πÄ‡∏Å‡∏• (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)" placeholder="‡πÄ‡∏ä‡πà‡∏ô 200 ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 200px = 1‡∏°.">
            </div>
        </div>
        
        <div class="instructions">
            <h3>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</h3>
            <ul>
                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</li>
                <li>‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</li>
                <li>‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏û)</li>
                <li>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"</li>
                <li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ <b>‡∏™‡πÄ‡∏Å‡∏•</b> ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏ï‡πà‡∏≠ 1 ‡πÄ‡∏°‡∏ï‡∏£</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 100 px = 1 m)</li>
            </ul>
        </div>
        
        <div class="results">
            <div class="result-item">
                <span class="result-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span>
                <span class="result-value" id="distance">0 ‡∏°.</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
                <span class="result-value" id="area">0 ‡∏ï‡∏£.‡∏°.</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á:</span>
                <span class="result-value" id="height">0 ‡∏°.</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î:</span>
                <span class="result-value" id="point-count">0</span>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'distance';
        let points = [];
        let video = document.getElementById('video');
        let stream = null;
        let cameraActive = false;
        let calibrationMode = false;
        let calibrationPoints = []; // [{x,y} x2]
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function initCamera(deviceId = null) {
            const statusElement = document.getElementById('camera-status');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö getUserMedia ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusElement.style.display = 'block';
                statusElement.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ';
                statusElement.style.color = '#ff4757';
                return;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            statusElement.style.display = 'block';
            statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
            statusElement.style.color = '#00ff88';
            
            // ‡∏õ‡∏¥‡∏î stream ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            try {
                // ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∏ deviceId ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                if (deviceId) {
                    statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...';
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: { exact: deviceId },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        }
                    });
                } else {
                    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° environment (‡πÑ‡∏°‡πà exact ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iOS) -> user -> ‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ
                    const cameraConfigs = [
                        {
                            name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á',
                            constraints: {
                                video: {
                                    facingMode: { ideal: 'environment' },
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            }
                        },
                        {
                            name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤',
                            constraints: {
                                video: {
                                    facingMode: { ideal: 'user' },
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            }
                        },
                        {
                            name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ',
                            constraints: {
                                video: {
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            }
                        }
                    ];

                    let cameraOpened = false;
                    for (const config of cameraConfigs) {
                        if (cameraOpened) break;
                        try {
                            statusElement.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î${config.name}...`;
                            console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á${config.name}...`);
                            stream = await navigator.mediaDevices.getUserMedia(config.constraints);
                            if (stream && stream.getVideoTracks().length > 0) {
                                console.log(`${config.name}‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                                cameraOpened = true;
                                break;
                            }
                        } catch (configError) {
                            console.log(`${config.name}‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:`, configError.message);
                            if (stream) {
                                stream.getTracks().forEach(track => track.stop());
                                stream = null;
                            }
                        }
                    }
                    if (!cameraOpened || !stream) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
                    }
                }
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ video element
                statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠...';
                
                // ‡∏•‡πâ‡∏≤‡∏á srcObject ‡πÄ‡∏Å‡πà‡∏≤
                if (video.srcObject) {
                    video.srcObject = null;
                }
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ video attributes
                video.muted = true;
                video.playsInline = true;
                video.autoplay = true;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ stream ‡πÉ‡∏´‡∏°‡πà
                video.srcObject = stream;
                
                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ video ‡∏û‡∏£‡πâ‡∏≠‡∏°
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Video loading timeout'));
                    }, 10000); // timeout 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    
                    video.onloadedmetadata = () => {
                        clearTimeout(timeout);
                        console.log('Video metadata loaded');
                        resolve();
                    };
                    
                    video.onerror = (error) => {
                        clearTimeout(timeout);
                        console.error('Video error:', error);
                        reject(error);
                    };
                });
                
                // ‡πÄ‡∏•‡πà‡∏ô video
                try {
                    await video.play();
                    console.log('Video playing');
                } catch (playError) {
                    console.log('Auto-play failed, but video is ready:', playError.message);
                }
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                cameraActive = true;
                statusElement.style.display = 'none';
                console.log('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á
                try { await populateCameraSelect(); } catch(e) { console.log('populateCameraSelect error', e); }
                
            } catch (error) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ:', error);
                cameraActive = false;
                statusElement.style.display = 'block';
                statusElement.style.color = '#ff4757';
                
                // ‡∏õ‡∏¥‡∏î stream ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                if (error.name === 'NotAllowedError') {
                    statusElement.textContent = '‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
                } else if (error.name === 'NotFoundError') {
                    statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
                } else if (error.name === 'NotReadableError') {
                    statusElement.textContent = '‚ùå ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                } else if (error.name === 'OverconstrainedError') {
                    statusElement.textContent = '‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
                } else if (error.name === 'SecurityError') {
                    statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS)';
                } else {
                    statusElement.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                }
            }
        }
        
        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function testCamera() {
            const statusElement = document.getElementById('camera-status');
            statusElement.style.display = 'block';
            statusElement.style.color = '#00ff88';
            statusElement.textContent = 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
            console.log('=== ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á ===');
            console.log('User Agent:', navigator.userAgent);
            console.log('Protocol:', location.protocol);
            console.log('Hostname:', location.hostname);
            
            if (!navigator.mediaDevices) {
                statusElement.textContent = '‚ùå navigator.mediaDevices ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
                statusElement.style.color = '#ff4757';
                return;
            }
            
            if (!navigator.mediaDevices.getUserMedia) {
                statusElement.textContent = '‚ùå getUserMedia ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
                statusElement.style.color = '#ff4757';
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ
            try {
                statusElement.textContent = 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ...';
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', devices);
                console.log('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠:', videoDevices);
                
                if (videoDevices.length === 0) {
                    statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
                    statusElement.style.color = '#ff4757';
                    return;
                }
                
                statusElement.textContent = `‚úÖ ‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á ${videoDevices.length} ‡∏ï‡∏±‡∏ß - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...`;
                
                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
                const testConstraints = { video: true };
                const testStream = await navigator.mediaDevices.getUserMedia(testConstraints);
                
                if (testStream) {
                    statusElement.textContent = '‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥';
                    statusElement.style.color = '#00ff88';
                    
                    // ‡∏õ‡∏¥‡∏î test stream
                    testStream.getTracks().forEach(track => track.stop());
                    
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
                    setTimeout(() => {
                        initCamera();
                    }, 1000);
                } else {
                    statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
                    statusElement.style.color = '#ff4757';
                }
                
            } catch (error) {
                console.error('‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
                statusElement.style.color = '#ff4757';
                
                if (error.name === 'NotAllowedError') {
                    statusElement.textContent = '‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                } else if (error.name === 'NotFoundError') {
                    statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                } else if (error.name === 'SecurityError') {
                    statusElement.textContent = '‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS)';
                } else {
                    statusElement.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                }
            }
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function toggleCamera() {
            const statusElement = document.getElementById('camera-status');
            
            if (cameraActive) {
                // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                if (stream) {
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                    });
                    video.srcObject = null;
                    stream = null;
                }
                cameraActive = false;
                statusElement.style.display = 'block';
                statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                statusElement.style.color = '#ff4757';
            } else {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                initCamera();
            }
        }
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î
        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if (btn) {
                btn.classList.add('active');
            }
            clearPoints();
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
            const instructions = document.querySelector('.instructions ul');
            switch(mode) {
                case 'distance':
                    instructions.innerHTML = `
                        <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</li>
                        <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î" ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á</li>
                        <li>‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</li>
                    `;
                    break;
                case 'area':
                    instructions.innerHTML = `
                        <li>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏≠‡∏ö‡πÜ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</li>
                        <li>‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</li>
                        <li>‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</li>
                    `;
                    break;
                case 'height':
                    instructions.innerHTML = `
                        <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î</li>
                        <li>‡∏ñ‡∏∑‡∏≠‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á</li>
                        <li>‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</li>
                    `;
                    break;
            }
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î
        function addPoint(x = null, y = null) {
            if (!cameraActive) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }
            
            const container = document.querySelector('.camera-container');
            const rect = container.getBoundingClientRect();
            
            // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            if (x === null || y === null) {
                x = rect.width / 2;
                y = rect.height / 2;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏ü‡∏£‡∏° ‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å
            if (x < 0 || y < 0 || x > rect.width || y > rect.height) return;

            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
            if (currentMode === 'height' && points.length >= 2) {
                alert('‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 2 ‡∏à‡∏∏‡∏î (‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î)');
                return;
            }
            if (currentMode === 'distance' && points.length >= 2) {
                alert('‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô-‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)');
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
            const point = {
                id: points.length,
                x: x,
                y: y
            };
            
            points.push(point);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const pointElement = document.createElement('div');
            pointElement.className = 'point';
            pointElement.style.left = x + 'px';
            pointElement.style.top = y + 'px';
            pointElement.title = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${point.id + 1}`;
            
            document.getElementById('points').appendChild(pointElement);
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            updateInfo();
            drawLines();
        }
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function clearPoints() {
            points = [];
            document.getElementById('points').innerHTML = '';
            updateInfo();
            updateResults();
        }

        // ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        function undoPoint() {
            if (points.length === 0) return;
            points.pop();
            const pts = document.getElementById('points');
            if (pts.lastChild) pts.removeChild(pts.lastChild);
            updateInfo();
            drawLines();
        }
        
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î
        function drawLines() {
            // ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏Å‡πà‡∏≤
            document.querySelectorAll('.measurement-line').forEach(line => line.remove());
            
            if (points.length < 2) return;
            
            const container = document.getElementById('points');
            
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];
                
                const line = document.createElement('div');
                line.className = 'measurement-line';
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.left = p1.x + 'px';
                line.style.top = p1.y + 'px';
                line.style.width = length + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                
                container.appendChild(line);
            }
            
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            if (currentMode === 'area' && points.length > 2) {
                const p1 = points[points.length - 1];
                const p2 = points[0];
                
                const line = document.createElement('div');
                line.className = 'measurement-line';
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.left = p1.x + 'px';
                line.style.top = p1.y + 'px';
                line.style.width = length + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                
                container.appendChild(line);
            }
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function calculate() {
            if (points.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            let distance = 0;
            let area = 0;
            let height = 0;
            
            switch (currentMode) {
                case 'distance':
                    if (points.length >= 2) {
                        distance = calculateDistance();
                    }
                    break;
                    
                case 'area':
                    if (points.length >= 3) {
                        area = calculateArea();
                    } else {
                        alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
                        return;
                    }
                    break;
                    
                case 'height':
                    if (points.length >= 2) {
                        height = calculateHeight();
                    }
                    break;
            }
            
            updateResults(distance, area, height);
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        function getScalePxPerMeter() {
            const v = parseFloat(document.getElementById('scaleInput')?.value || '100');
            return isNaN(v) || v <= 0 ? 100 : v;
        }

        function calculateDistance() {
            let totalDistance = 0;
            const s = getScalePxPerMeter();
            
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const distance = Math.sqrt(dx * dx + dy * dy) / s; // ‡πÄ‡∏°‡∏ï‡∏£
                totalDistance += distance;
            }
            
            return totalDistance;
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        function calculateArea() {
            if (points.length < 3) return 0;
            
            // ‡πÉ‡∏ä‡πâ Shoelace formula
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].x * points[j].y;
                area -= points[j].x * points[i].y;
            }
            const s = getScalePxPerMeter();
            return Math.abs(area) / 2 / (s * s); // ‡∏ï‡∏£.‡∏°.
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
        function calculateHeight() {
            if (points.length < 2) return 0;
            
            const p1 = points[0];
            const p2 = points[points.length - 1];
            
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏™‡πÄ‡∏Å‡∏•)
            const s = getScalePxPerMeter();
            return Math.abs(p2.y - p1.y) / s;
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î
        function updateInfo() {
            document.getElementById('info').textContent = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: ${points.length}`;
            document.getElementById('point-count').textContent = points.length;
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function updateResults(distance = 0, area = 0, height = 0) {
            document.getElementById('distance').textContent = distance.toFixed(2) + ' ‡∏°.';
            document.getElementById('area').textContent = area.toFixed(2) + ' ‡∏ï‡∏£.‡∏°.';
            document.getElementById('height').textContent = height.toFixed(2) + ' ‡∏°.';
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞
        function checkCameraStatus() {
            if (stream) {
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack && videoTrack.readyState === 'ended') {
                    console.log('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å');
                    cameraActive = false;
                    const statusElement = document.getElementById('camera-status');
                    statusElement.style.display = 'block';
                    statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                    statusElement.style.color = '#ff4757';
                }
            }
        }
        
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        (function setupTapToAdd() {
            const container = document.querySelector('.camera-container');
            let lastAddTs = 0;
            function addPointFromEvent(e) {
                if (!cameraActive) return;
                const now = Date.now();
                if (now - lastAddTs < 250) return; // debounce 250ms
                const rect = container.getBoundingClientRect();
                let clientX, clientY;
                if (e.touches && e.touches.length) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                if (calibrationMode) {
                    handleCalibrationTap(x, y);
                } else {
                    addPoint(x, y);
                }
                lastAddTs = now;
            }
            container.addEventListener('click', addPointFromEvent);
            container.addEventListener('touchstart', function(e){ addPointFromEvent(e); }, { passive: true });
        })();

        // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï: ‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πÄ‡∏Å‡∏• px/‡∏°.
        function toggleCalibration() {
            calibrationMode = !calibrationMode;
            const btn = document.getElementById('calibBtn');
            const statusElement = document.getElementById('camera-status');
            if (calibrationMode) {
                calibrationPoints = [];
                removeCalibrationMarkers();
                btn.textContent = '‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï... (‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î)';
                statusElement.style.display = 'block';
                statusElement.textContent = 'üéØ ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï: ‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á';
                statusElement.style.color = '#2ed573';
            } else {
                btn.textContent = 'üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡πÄ‡∏Å‡∏•';
                statusElement.style.display = 'block';
                statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                statusElement.style.color = '#ffeb3b';
                removeCalibrationMarkers();
            }
        }

        function handleCalibrationTap(x, y) {
            const container = document.querySelector('.camera-container');
            const rect = container.getBoundingClientRect();
            if (x < 0 || y < 0 || x > rect.width || y > rect.height) return;

            // ‡∏ß‡∏≤‡∏î marker ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            const marker = document.createElement('div');
            marker.className = 'calib-point';
            marker.style.position = 'absolute';
            marker.style.width = '10px';
            marker.style.height = '10px';
            marker.style.borderRadius = '50%';
            marker.style.background = '#2ed573';
            marker.style.border = '2px solid #145a32';
            marker.style.left = (x - 5) + 'px';
            marker.style.top = (y - 5) + 'px';
            document.getElementById('points').appendChild(marker);

            calibrationPoints.push({ x, y });
            if (calibrationPoints.length === 2) {
                const [p1, p2] = calibrationPoints;
                const pixelDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
                const realMetersStr = prompt(`‡∏£‡∏∞‡∏¢‡∏∞‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏• ‚âà ${pixelDist.toFixed(2)} px\n‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£):`, '1');
                const realMeters = parseFloat(realMetersStr);
                if (!isNaN(realMeters) && realMeters > 0) {
                    const scale = pixelDist / realMeters; // px ‡∏ï‡πà‡∏≠ 1 ‡πÄ‡∏°‡∏ï‡∏£
                    const scaleInput = document.getElementById('scaleInput');
                    scaleInput.value = Math.max(1, Math.round(scale));
                    try { localStorage.setItem('scalePxPerMeter', scaleInput.value); } catch {}
                    updateRuler();
                    alert(`‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô ~ ${scaleInput.value} px/‡∏°.`);
                } else {
                    alert('‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï');
                }
                // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á marker
                calibrationMode = false;
                const btn = document.getElementById('calibBtn');
                btn.textContent = 'üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡πÄ‡∏Å‡∏•';
                removeCalibrationMarkers();
            }
        }

        function removeCalibrationMarkers() {
            calibrationPoints = [];
            document.querySelectorAll('.calib-point').forEach(el => el.remove());
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πÄ‡∏Å‡∏•‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function updateRuler() {
            const bar = document.getElementById('rulerBar');
            const label = document.getElementById('rulerLabel');
            const container = document.querySelector('.camera-container');
            if (!bar || !label || !container) return;
            const rect = container.getBoundingClientRect();
            const scaleInput = document.getElementById('scaleInput');
            const pxPerMeter = Math.max(1, parseFloat(scaleInput.value) || 100);

            // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß = 1 ‡πÄ‡∏°‡∏ï‡∏£ ‡∏´‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏≠)
            const maxBar = Math.max(80, Math.min(rect.width - 40, 240));
            const targetWidth = pxPerMeter; // 1 ‡πÄ‡∏°‡∏ï‡∏£
            const barWidth = Math.round(Math.max(80, Math.min(targetWidth, maxBar)));
            bar.style.width = barWidth + 'px';
            label.textContent = `‡∏™‡πÄ‡∏Å‡∏•: 1 ‡∏°. ‚âà ${pxPerMeter} px` + (barWidth < pxPerMeter ? ' (‡πÅ‡∏™‡∏î‡∏á‡∏¢‡πà‡∏≠)' : '');

            // ‡∏•‡∏ö tick ‡πÄ‡∏î‡∏¥‡∏°
            bar.querySelectorAll('.tick, .tick-label').forEach(el => el.remove());

            // ‡∏ß‡∏≤‡∏î tick ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏Å‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏≠
            const maxMetersShown = barWidth / pxPerMeter; // ‡πÄ‡∏°‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ô‡πÅ‡∏ñ‡∏ö
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å step ‡∏¢‡πà‡∏≠‡∏¢
            let minorStep = 0.5; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0.5 ‡∏°.
            if (pxPerMeter * 0.5 < 40) {
                // ‡∏ñ‡πâ‡∏≤ 0.5 ‡πÄ‡∏°‡∏ï‡∏£‡πÅ‡∏Ñ‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏•‡∏±‡∏Å 1 ‡πÄ‡∏°‡∏ï‡∏£
                minorStep = 1;
            } else if (pxPerMeter * 0.25 >= 40 && maxMetersShown >= 1) {
                // ‡∏ñ‡πâ‡∏≤‡∏û‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏™‡∏î‡∏á 0.25 ‡∏î‡πâ‡∏ß‡∏¢
                minorStep = 0.25;
            }

            // ‡∏ß‡∏≤‡∏î tick ‡∏ó‡∏µ‡πà 0 ‡∏°.
            const tick0 = document.createElement('div');
            tick0.className = 'tick major';
            tick0.style.left = '0px';
            bar.appendChild(tick0);
            const lbl0 = document.createElement('div');
            lbl0.className = 'tick-label';
            lbl0.style.left = '0px';
            lbl0.textContent = '0 ‡∏°.';
            bar.appendChild(lbl0);

            // ‡∏ß‡∏≤‡∏î‡∏à‡∏≤‡∏Å 0 ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ
            const endMeters = Math.max(minorStep, Math.min(1, maxMetersShown));
            for (let m = minorStep; m <= endMeters + 1e-6; m += minorStep) {
                const x = Math.round(m * pxPerMeter);
                if (x > barWidth) break;
                const isMajor = Math.abs(m - Math.round(m)) < 1e-6; // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏°‡∏ï‡∏£
                const isHalf = Math.abs(m - 0.5) < 1e-6; // 0.5 ‡πÄ‡∏°‡∏ï‡∏£‡πÅ‡∏£‡∏Å

                const tick = document.createElement('div');
                tick.className = 'tick ' + (isMajor ? 'major' : 'minor');
                tick.style.left = x + 'px';
                bar.appendChild(tick);

                // ‡πÅ‡∏™‡∏î‡∏á label ‡∏ó‡∏µ‡πà 0.5 ‡∏°. ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏°.
                if (isMajor || isHalf) {
                    const lbl = document.createElement('div');
                    lbl.className = 'tick-label';
                    lbl.style.left = x + 'px';
                    lbl.textContent = (isHalf ? '0.5 ‡∏°.' : `${Math.round(m)} ‡∏°.`);
                    bar.appendChild(lbl);
                }
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á autoplay block ‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™)
        window.addEventListener('load', () => {
            console.log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á');
            const statusElement = document.getElementById('camera-status');
            statusElement.style.display = 'block';
            statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
            statusElement.style.color = '#ffeb3b';
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(checkCameraStatus, 2000);
            // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(() => {
                    console.log('Service Worker registered');
                }).catch(err => console.log('SW registration failed', err));
            }

            // Restore/Save scale from localStorage
            const scaleInput = document.getElementById('scaleInput');
            try {
                const saved = localStorage.getItem('scalePxPerMeter');
                if (saved) scaleInput.value = saved;
            } catch {}
            updateRuler();
            scaleInput.addEventListener('input', () => {
                try { localStorage.setItem('scalePxPerMeter', scaleInput.value); } catch {}
                updateRuler();
            });
            window.addEventListener('resize', () => {
                updateRuler();
            });
        });
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    console.log('‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
                });
            }
        });
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô');
            } else {
                console.log('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á');
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                checkCameraStatus();
            }
        });
    </script>
</body>
</html>
