<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            animation: fadeInUp 0.6s ease-out;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            /* ‡πÉ‡∏ä‡πâ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ responsive */
            aspect-ratio: 16 / 9;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
            animation: fadeInScale 0.8s ease-out 0.1s both;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid #00ff88;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,255,136,0.5);
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0,255,136,0.8);
        }
        
        .crosshair::before {
            top: 50%;
            left: -10px;
            right: -10px;
            height: 2px;
            transform: translateY(-50%);
        }
        
        .crosshair::after {
            left: 50%;
            top: -10px;
            bottom: -10px;
            width: 2px;
            transform: translateX(-50%);
        }
        
        .measurement-points {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff4757;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255,71,87,0.8);
            animation: pulse 2s infinite, bounceIn 0.5s ease-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        .measurement-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #ff4757, #00ff88);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transform-origin: left center;
            animation: drawLine 0.8s ease-out, lineGlow 3s ease-in-out infinite 0.8s;
        }
        
        @keyframes drawLine {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }

        .input, select {
            padding: 15px 18px;
            border-radius: 15px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            outline: none;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .input:focus, select:focus {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(0,255,136,0.5);
            box-shadow: 0 0 20px rgba(0,255,136,0.3);
            transform: translateY(-2px);
        }

        .input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        select option { 
            color: #111; 
            background: #fff;
            padding: 10px;
        }
        
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00d4aa);
            color: white;
            box-shadow: 0 8px 25px rgba(0,255,136,0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #00d4aa, #00ff88);
            box-shadow: 0 12px 35px rgba(0,255,136,0.6);
            transform: translateY(-3px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            box-shadow: 0 8px 25px rgba(255,71,87,0.4);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #ff3742, #ff4757);
            box-shadow: 0 12px 35px rgba(255,71,87,0.6);
            transform: translateY(-3px);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3742fa, #2f3542);
            color: white;
            box-shadow: 0 8px 25px rgba(55,66,250,0.4);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #2f3542, #3742fa);
            box-shadow: 0 12px 35px rgba(55,66,250,0.6);
            transform: translateY(-3px);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .mode-selector {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }
        
        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mode-btn:hover::before {
            opacity: 1;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }

        .mode-btn.active::before {
            opacity: 0;
        }
        
        .results {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 500;
            opacity: 0.9;
        }
        
        .result-value {
            font-size: 18px;
            font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0,255,136,0.3);
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border-left: 4px solid #00ff88;
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #00ff88;
        }
        
        .instructions ul {
            list-style: none;
            padding-left: 0;
        }
        
        .instructions li {
            padding: 5px 0;
            opacity: 0.9;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .instructions li::before {
            content: "üì± ";
            margin-right: 8px;
        }

        .instructions li:hover {
            transform: translateX(5px);
            color: #00ff88;
        }

        /* Math formulas section */
        .math-formulas {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-left: 4px solid #ff6b6b;
            animation: fadeInUp 0.6s ease-out 0.6s both;
        }

        .math-formulas h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .formula-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .formula-item:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .formula-title {
            color: #ffd93d;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .formula-equation {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #6bcf7f;
            margin-bottom: 5px;
        }

        .formula-desc {
            font-size: 12px;
            opacity: 0.8;
            color: #e1e1e1;
        }

        /* Calculation steps display */
        .calculation-steps {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-left: 4px solid #6bcf7f;
            display: none;
        }

        .calculation-steps.show {
            display: block;
        }

        .calculation-steps h3 {
            color: #6bcf7f;
            margin-bottom: 15px;
            text-align: center;
        }

        .step-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #6bcf7f;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .step-item:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .step-number {
            color: #ffd93d;
            font-weight: bold;
            margin-right: 8px;
        }

        .step-formula {
            font-family: 'Courier New', monospace;
            color: #6bcf7f;
            margin: 5px 0;
        }

        .step-result {
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Angle indicator */
        .angle-indicator {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }

        .angle-arc {
            stroke: #ffd93d;
            stroke-width: 2;
            fill: none;
            opacity: 0.8;
        }

        .angle-label {
            fill: #ffd93d;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .camera-status {
            text-align: center;
            padding: 20px;
            color: #ff4757;
            font-weight: 500;
        }
        
        .measurement-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        /* Ruler overlay */
        .ruler-overlay {
            position: absolute;
            left: 10px;
            bottom: 10px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
        }
        .ruler-label { opacity: 0.9; }
        .ruler-bar {
            height: 8px;
            margin-top: 6px;
            background: repeating-linear-gradient(90deg, #ffffff, #ffffff 1px, transparent 1px, transparent 10px);
            border: 1px solid #ffffff;
            border-radius: 3px;
            width: 120px; /* will be overridden by JS */
            position: relative;
        }
        .ruler-bar::after {
            content: '';
            position: absolute;
            right: -1px;
            top: -4px;
            bottom: -4px;
            width: 2px;
            background: #ffffff;
        }

        .tick {
            position: absolute;
            bottom: 100%;
            width: 1px;
            background: #fff;
        }
        .tick.minor { height: 6px; opacity: 0.8; }
        .tick.major { height: 10px; }
        .tick-label {
            position: absolute;
            bottom: calc(100% + 12px);
            transform: translateX(-50%);
            color: #fff;
            font-size: 11px;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        }

        /* Small field label for inputs */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field-label {
            font-size: 12px;
            opacity: 0.85;
        }
        /* Hide camera selector for simpler UX */
        #cameraSelect { display: none; }
        /* Hide green center crosshair */
        .crosshair { display: none; }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .camera-container {
                aspect-ratio: 3 / 4;
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Modern UI Animations and Transitions */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Enhanced loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -200px;
            width: 200px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        /* Staggered animations for cards */
        .header {
            animation: fadeInUp 0.6s ease-out;
        }

        .camera-container {
            animation: fadeInScale 0.8s ease-out 0.1s both;
        }

        .mode-selector {
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .controls {
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }

        .results {
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }

        .instructions {
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        .math-formulas {
            animation: fadeInUp 0.6s ease-out 0.6s both;
        }

        /* Enhanced button interactions */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
        }

        /* Enhanced focus states */
        .input:focus, .btn:focus, .mode-btn:focus {
            outline: 2px solid rgba(0,255,136,0.5);
            outline-offset: 2px;
        }

        /* Smooth transitions for all interactive elements */
        .result-item, .formula-item, .step-item, .instructions li {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced hover effects */
        .formula-item:hover, .step-item:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .instructions li:hover {
            transform: translateX(5px);
            color: #00ff88;
        }

        /* Point addition animation */
        .point {
            animation: bounceIn 0.5s ease-out;
        }

        /* Measurement line drawing animation */
        .measurement-line {
            animation: drawLine 0.8s ease-out, lineGlow 3s ease-in-out infinite 0.8s;
        }

        @keyframes drawLine {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        /* Enhanced card hover effects */
        .results:hover, .instructions:hover, .math-formulas:hover, .calculation-steps:hover {
            border-color: rgba(255,255,255,0.4);
        }

        /* Optimized spacing and layout */
        .container > * + * {
            margin-top: 0;
        }

        .field {
            margin-bottom: 15px;
        }

        .field:last-child {
            margin-bottom: 0;
        }

        .field-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        /* Enhanced visual hierarchy */
        h2, h3 {
            margin-bottom: 1rem;
            font-weight: 700;
        }

        h2 {
            font-size: 1.5rem;
            color: #00ff88;
        }

        h3 {
            font-size: 1.25rem;
        }

        /* Better text readability */
        p, li, span {
            line-height: 1.6;
        }

        /* Enhanced status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-success {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            border: 1px solid rgba(0,255,136,0.3);
        }

        .status-warning {
            background: rgba(255,215,61,0.2);
            color: #ffd93d;
            border: 1px solid rgba(255,215,61,0.3);
        }

        .status-error {
            background: rgba(255,71,87,0.2);
            color: #ff4757;
            border: 1px solid rgba(255,71,87,0.3);
        }

        /* Enhanced tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: rgba(0,0,0,0.9);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            animation: fadeInUp 0.3s ease-out;
        }

        [data-tooltip]:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            border: 5px solid transparent;
            border-top-color: rgba(0,0,0,0.9);
            z-index: 1000;
        }

        /* Enhanced scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .control-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 10px;
            border-left: 4px solid #00ff88;
        }

        .control-section h3 {
            color: #00ff88;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞">

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìè ‡πÅ‡∏≠‡∏õ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</h1>
            <p>‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</p>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('distance', this)">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß</button>
            <button class="mode-btn" onclick="setMode('area', this)">‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
            <button class="mode-btn" onclick="setMode('height', this)">‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</button>
            <button class="mode-btn" onclick="setMode('angle', this)">‡∏ß‡∏±‡∏î‡∏°‡∏∏‡∏° (‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥)</button>
        </div>
        
        <!-- Math Formulas Section -->
        <div class="math-formulas">
            <h3>üßÆ ‡∏™‡∏π‡∏ï‡∏£‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</h3>
            <div class="formula-grid">
                <div class="formula-item">
                    <div class="formula-title">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sine</div>
                    <div class="formula-equation">sin Œ∏ = ‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏° / ‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á</div>
                    <div class="formula-desc">‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞</div>
                </div>
                <div class="formula-item">
                    <div class="formula-title">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Cosine</div>
                    <div class="formula-equation">cos Œ∏ = ‡∏õ‡∏£‡∏∞‡∏ä‡∏¥‡∏î / ‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á</div>
                    <div class="formula-desc">‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏°‡∏∏‡∏°</div>
                </div>
                <div class="formula-item">
                    <div class="formula-title">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Tangent</div>
                    <div class="formula-equation">tan Œ∏ = ‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏° / ‡∏õ‡∏£‡∏∞‡∏ä‡∏¥‡∏î</div>
                    <div class="formula-desc">‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô</div>
                </div>
                <div class="formula-item">
                    <div class="formula-title">‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ö‡∏ó‡∏û‡∏µ‡∏ó‡∏≤‡πÇ‡∏Å‡∏£‡∏±‡∏™</div>
                    <div class="formula-equation">c¬≤ = a¬≤ + b¬≤</div>
                    <div class="formula-desc">‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏à‡∏∏‡∏î</div>
                </div>
            </div>
        </div>
        
        <div class="camera-container">
            <video id="video" autoplay playsinline webkit-playsinline></video>
            <div class="camera-overlay">
                <div class="crosshair"></div>
                <div class="measurement-points" id="points"></div>
                <div class="measurement-info" id="info">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: 0</div>
                <div class="ruler-overlay" id="rulerOverlay">
                    <div class="ruler-label" id="rulerLabel">‡∏™‡πÄ‡∏Å‡∏•: 1 ‡∏°. ‚âà 100 px</div>
                    <div class="ruler-bar" id="rulerBar"></div>
                </div>
            </div>
            <div class="camera-status" id="camera-status" style="display: none;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...
            </div>
        </div>
        
        <div class="">
            <!-- Common Controls -->
            <div class="control-section">
                <h3>üîÑ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="calculate()">üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                    <button class="btn" onclick="undoPoint()">‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î</button>
                    <button class="btn btn-secondary" onclick="clearPoints()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î</button>
                    <button class="btn btn-info" onclick="toggleCamera()">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
            </div>
            
            <!-- Camera Controls -->
            <div class="control-section" id="cameraControls">
                <h3>üé• ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á</h3>
                <div class="control-grid">
                    <!-- <div class="field">
                        <label for="cameraSelect" class="field-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
                        <select id="cameraSelect" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á" onchange="onCameraChange(this.value)"></select>
                    </div> -->
                    <div class="field">
                        <label for="cameraHeightInput" class="field-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÄ‡∏°‡∏ï‡∏£)</label>
                        <input id="cameraHeightInput" type="number" class="input" min="0.5" max="3" step="0.1" value="1.5" onchange="updateCameraHeight(this.value)" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-info" id="refreshBtn" onclick="refreshCameras()" style="display:none">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                        <button class="btn btn-info" onclick="resetPerspectiveSettings()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                    </div>
                </div>
            </div>
            
            <!-- Measurement Controls -->
            <div class="control-section" id="measurementControls" style="display: none;">
                <h3>üìê ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î</h3>
                <div class="control-grid">
                    <div class="field">
                        <label for="scaleInput" class="field-label">‡∏™‡πÄ‡∏Å‡∏• (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏ï‡πà‡∏≠ 1 ‡πÄ‡∏°‡∏ï‡∏£)</label>
                        <input id="scaleInput" type="number" class="input" min="1" step="1" value="100" title="‡∏™‡πÄ‡∏Å‡∏• (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)" placeholder="‡πÄ‡∏ä‡πà‡∏ô 200 ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á 200px = 1‡∏°.">
                    </div>
                    <div class="btn-group">
                        <button class="btn" id="calibBtn" onclick="toggleCalibration()">üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡πÄ‡∏Å‡∏•</button>
                        <button class="btn btn-info" onclick="autoCalibrate()">üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
            </div>
            
            <!-- Height Mode Controls (Law of Cosines Calculator) -->
            <div class="control-section" id="heightControls" style="display: none;">
                <h3>üìê ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç Law of Cosines</h3>
                <p style="font-size: 12px; color: #e1e1e1; margin: 5px 0 15px;">‡∏™‡∏π‡∏ï‡∏£: c¬≤ = a¬≤ + b¬≤ - 2ab cos(C) ‡πÄ‡∏°‡∏∑‡πà‡∏≠ c = ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á</p>
                <div class="control-grid">
                    <div class="field">
                        <label for="angleInput" class="field-label">‡∏°‡∏∏‡∏° C (‡∏≠‡∏á‡∏®‡∏≤)</label>
                        <input id="angleInput" type="number" class="input" min="0" max="180" step="0.1" value="90" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏∏‡∏° C ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏≠‡∏á‡∏®‡∏≤" onchange="calculateHeightFromLawOfCosines()">
                    </div>
                    <div class="field">
                        <label for="sideAInput" class="field-label">‡∏î‡πâ‡∏≤‡∏ô a (‡πÄ‡∏°‡∏ï‡∏£)</label>
                        <input id="sideAInput" type="number" class="input" min="0.1" max="100" step="0.1" value="3.0" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô a" onchange="calculateHeightFromLawOfCosines()">
                    </div>
                    <div class="field">
                        <label for="sideBInput" class="field-label">‡∏î‡πâ‡∏≤‡∏ô b (‡πÄ‡∏°‡∏ï‡∏£)</label>
                        <input id="sideBInput" type="number" class="input" min="0.1" max="100" step="0.1" value="4.0" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô b" onchange="calculateHeightFromLawOfCosines()">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</h3>
            <ul id="instructionsList">
                <li><strong>‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î" ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"</li>
                <li><strong>‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏≠‡∏ö‡πÜ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"</li>
                <li><strong>‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á:</strong> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏° C ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏î‡πâ‡∏≤‡∏ô a, b ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç Law of Cosines ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"</li>
                <li><strong>‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∏‡∏°:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏à‡∏∏‡∏î (‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"</li>
            </ul>
        </div>
        
        <!-- Calculation Steps Display -->
        <div class="calculation-steps" id="calculationSteps">
            <h3>üìä ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥</h3>
            <div id="stepsContent">
                <!-- Steps will be populated by JavaScript -->
            </div>
        </div>

        <div class="results">
            <div class="result-item">
                <span class="result-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span>
                <span class="result-value" id="distance">0 ‡∏°.</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
                <span class="result-value" id="area">0 ‡∏ï‡∏£.‡∏°.</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á:</span>
                <span class="result-value" id="height">0 ‡∏°.</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏°‡∏∏‡∏°:</span>
                <span class="result-value" id="angle">0¬∞</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î:</span>
                <span class="result-value" id="point-count">0</span>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'distance';
        let points = [];
        let video = document.getElementById('video');
        let stream = null;
        let cameraActive = false;
        let calibrationMode = false;
        let calibrationPoints = []; // [{x,y} x2]
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Advanced Perspective Correction (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
        let cameraFOV = {
            horizontal: 60, // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            vertical: 45    // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        };
        let cameraHeight = 1.5; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô (‡πÄ‡∏°‡∏ï‡∏£)
        let cameraTilt = 0; // ‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏≠‡∏á‡∏®‡∏≤)
        let deviceOrientation = { alpha: 0, beta: 0, gamma: 0 }; // ‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        let manualDistanceMode = false; // ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏≠‡∏á
        let manualDistance = 5.0; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (‡πÄ‡∏°‡∏ï‡∏£)
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö FOV
        let deviceInfo = {
            type: 'unknown',
            brand: 'unknown',
            model: 'unknown',
            isTablet: false,
            screenSize: 'medium'
        };
        
        // ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô
        let perpendicularMode = true; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        let targetTilt = 0; // ‡∏°‡∏∏‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        function initDeviceOrientation() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', function(event) {
                    deviceOrientation.alpha = event.alpha || 0; // Z-axis (compass)
                    deviceOrientation.beta = event.beta || 0;   // X-axis (front-back tilt)
                    deviceOrientation.gamma = event.gamma || 0; // Y-axis (left-right tilt)
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                    cameraTilt = deviceOrientation.beta;
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á
                    updateOrientationDisplay();
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    setInterval(() => {
                        if (cameraActive) {
                            calibrateCameraHeight(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏µ‡∏¢‡∏á
                            updateOrientationDisplay();
                            updateCameraHeightInput();
                        }
                    }, 1000);
                });
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function updateCameraHeight(value) {
            cameraHeight = parseFloat(value) || 1.5;
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï input ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        function updateCameraHeightInput() {
            const input = document.getElementById('cameraHeightInput');
            if (input && Math.abs(parseFloat(input.value) - cameraHeight) > 0.1) {
                input.value = cameraHeight.toFixed(1);
            }
        }
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Perspective Correction
        function resetPerspectiveSettings() {
            cameraFOV = { horizontal: 60, vertical: 45 }; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            cameraHeight = 1.5;
            cameraTilt = 0;
            deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
            
            document.getElementById('cameraHeightInput').value = cameraHeight;
            
            // ‡∏£‡∏µ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï
            if (cameraActive) {
                calibrateCameraFOV();
                calibrateCameraHeight();
            }
            
            alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Perspective Correction ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)');
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        function getAdvancedCalculationInfo() {
            return {
                fov: cameraFOV,
                height: cameraHeight,
                tilt: cameraTilt,
                orientation: deviceOrientation
            };      
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
        function updateOrientationDisplay() {
            const info = document.getElementById('info');
            if (info) {
                const tiltText = Math.abs(cameraTilt) > 5 ? 
                    ` | ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á: ${cameraTilt.toFixed(1)}¬∞` : '';
                info.textContent = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: ${points.length}${tiltText}`;
            }
        }
        
        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï FOV ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        async function calibrateCameraFOV() {
            if (!stream || !video.videoWidth) return;
            
            try {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• FOV ‡∏à‡∏≤‡∏Å MediaStreamTrack
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    const capabilities = videoTrack.getCapabilities();
                    
                    // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì FOV ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞ focal length (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (settings.width && settings.height) {
                        const aspectRatio = settings.width / settings.height;
                        
                        // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì FOV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)
                        if (aspectRatio > 1.5) { // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
                            cameraFOV.horizontal = 65; // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 75
                            cameraFOV.vertical = 50;   // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 60
                        } else { // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
                            cameraFOV.horizontal = 55; // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 65
                            cameraFOV.vertical = 40;   // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 50
                        }
                        
                        console.log('FOV calibrated:', cameraFOV);
                    }
                }
            } catch (error) {
                console.log('FOV calibration failed, using defaults:', error);
            }
        }
        
        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å
        function calibrateCameraHeight() {
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            const userAgent = navigator.userAgent.toLowerCase();
            
            if (userAgent.includes('mobile') || userAgent.includes('android') || userAgent.includes('iphone')) {
                // ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ - ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ñ‡∏∑‡∏≠
                cameraHeight = deviceOrientation.beta < -30 ? 1.2 : // ‡∏ñ‡∏∑‡∏≠‡∏™‡∏π‡∏á
                              deviceOrientation.beta > 30 ? 0.8 :   // ‡∏ñ‡∏∑‡∏≠‡∏ï‡πà‡∏≥
                              1.0; // ‡∏ñ‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
            } else {
                // ‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ/‡πÅ‡∏•‡πá‡∏õ‡∏ó‡πá‡∏≠‡∏õ
                cameraHeight = 1.3;
            }
        }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function initCamera(deviceId = null) {
            const statusElement = document.getElementById('camera-status');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö getUserMedia ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusElement.style.display = 'block';
                statusElement.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ';
                statusElement.style.color = '#ff4757';
                return;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            statusElement.style.display = 'block';
            statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
            statusElement.style.color = '#00ff88';
            
            // ‡∏õ‡∏¥‡∏î stream ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            try {
                // ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∏ deviceId ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                if (deviceId) {
                    statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...';
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: { exact: deviceId },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        }
                    });
                } else {
                    // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° environment (‡πÑ‡∏°‡πà exact ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iOS) -> user -> ‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ
                    const cameraConfigs = [
                        {
                            name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á',
                            constraints: {
                                video: {
                                    facingMode: { ideal: 'environment' },
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            }
                        },
                        {
                            name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤',
                            constraints: {
                                video: {
                                    facingMode: { ideal: 'user' },
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            }
                        },
                        {
                            name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ',
                            constraints: {
                                video: {
                                    width: { ideal: 1280, min: 640 },
                                    height: { ideal: 720, min: 480 }
                                }
                            }
                        }
                    ];

                    let cameraOpened = false;
                    for (const config of cameraConfigs) {
                        if (cameraOpened) break;
                        try {
                            statusElement.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î${config.name}...`;
                            console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á${config.name}...`);
                            stream = await navigator.mediaDevices.getUserMedia(config.constraints);
                            if (stream && stream.getVideoTracks().length > 0) {
                                console.log(`${config.name}‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                                cameraOpened = true;
                                break;
                            }
                        } catch (configError) {
                            console.log(`${config.name}‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:`, configError.message);
                            if (stream) {
                                stream.getTracks().forEach(track => track.stop());
                                stream = null;
                            }
                        }
                    }
                    if (!cameraOpened || !stream) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
                    }
                }
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ video element
                statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠...';
                
                // ‡∏•‡πâ‡∏≤‡∏á srcObject ‡πÄ‡∏Å‡πà‡∏≤
                if (video.srcObject) {
                    video.srcObject = null;
                }
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ video attributes
                video.muted = true;
                video.playsInline = true;
                video.autoplay = true;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ stream ‡πÉ‡∏´‡∏°‡πà
                video.srcObject = stream;
                
                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ video ‡∏û‡∏£‡πâ‡∏≠‡∏°
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Video loading timeout'));
                    }, 10000); // timeout 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    
                    video.onloadedmetadata = () => {
                        clearTimeout(timeout);
                        console.log('Video metadata loaded');
                        resolve();
                    };
                    
                    video.onerror = (error) => {
                        clearTimeout(timeout);
                        console.error('Video error:', error);
                        reject(error);
                    };
                });
                
                // ‡πÄ‡∏•‡πà‡∏ô video
                try {
                    await video.play();
                    console.log('Video playing');
                } catch (playError) {
                    console.log('Auto-play failed, but video is ready:', playError.message);
                }
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                cameraActive = true;
                statusElement.style.display = 'none';
                console.log('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
                initDeviceOrientation();
                await calibrateCameraFOV();
                calibrateCameraHeight();
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á
                try { await populateCameraSelect(); } catch(e) { console.log('populateCameraSelect error', e); }
                
            } catch (error) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ:', error);
                cameraActive = false;
                statusElement.style.display = 'block';
                statusElement.style.color = '#ff4757';
                
                // ‡∏õ‡∏¥‡∏î stream ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                if (error.name === 'NotAllowedError') {
                    statusElement.textContent = '‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
                } else if (error.name === 'NotFoundError') {
                    statusElement.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
                } else if (error.name === 'NotReadableError') {
                    statusElement.textContent = '‚ùå ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                } else if (error.name === 'OverconstrainedError') {
                    statusElement.textContent = '‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
                } else if (error.name === 'SecurityError') {
                    statusElement.textContent = '‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS)';
                } else {
                    statusElement.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                }
            }
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function toggleCamera() {
            const statusElement = document.getElementById('camera-status');
            
            if (cameraActive) {
                // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                if (stream) {
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                    });
                    video.srcObject = null;
                    stream = null;
                }
                cameraActive = false;
                statusElement.style.display = 'block';
                statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                statusElement.style.color = '#ff4757';
            } else {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
                initCamera();
            }
        }
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î
        let modeChangeInProgress = false;
        function setMode(mode, btn) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ã‡πâ‡∏≥
            if (modeChangeInProgress) {
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            
            try {
                modeChangeInProgress = true;
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô:', mode);
                currentMode = mode;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ DOM elements ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                const requiredElements = ['cameraControls', 'measurementControls', 'advancedCameraControls', 'heightControls', 'calculationSteps'];
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.warn('‡∏û‡∏ö elements ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ:', missingElements);
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î
                const modeButtons = document.querySelectorAll('.mode-btn');
                if (modeButtons.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î');
                }
                
                modeButtons.forEach(b => b.classList.remove('active'));
                if (btn) {
                    btn.classList.add('active');
                } else {
                    // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    modeButtons.forEach(button => {
                        const buttonText = button.textContent.toLowerCase();
                        if ((mode === 'distance' && buttonText.includes('‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á')) ||
                            (mode === 'area' && buttonText.includes('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà')) ||
                            (mode === 'height' && buttonText.includes('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á')) ||
                            (mode === 'angle' && buttonText.includes('‡∏°‡∏∏‡∏°'))) {
                            button.classList.add('active');
                        }
                    });
                }
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                try {
                    clearPoints();
                } catch (clearError) {
                    console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÑ‡∏î‡πâ:', clearError);
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏ö‡∏ö manual
                    points = [];
                    const pointsContainer = document.getElementById('points');
                    if (pointsContainer) {
                        pointsContainer.innerHTML = '';
                    }
                }
                
                // ‡∏ã‡πà‡∏≠‡∏ô UI sections ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
                const cameraControls = document.getElementById('cameraControls');
                const measurementControls = document.getElementById('measurementControls');
                const advancedCameraControls = document.getElementById('advancedCameraControls');
                const heightControls = document.getElementById('heightControls');
                
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                [cameraControls, measurementControls, advancedCameraControls, heightControls].forEach(element => {
                    if (element) element.style.display = 'none';
                });
                
                // ‡πÅ‡∏™‡∏î‡∏á UI sections ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
                switch(mode) {
                    case 'distance':
                        if (cameraControls) cameraControls.style.display = 'block';
                        if (measurementControls) measurementControls.style.display = 'block';
                        if (advancedCameraControls) advancedCameraControls.style.display = 'block';
                        break;
                        
                    case 'area':
                        if (cameraControls) cameraControls.style.display = 'block';
                        if (measurementControls) measurementControls.style.display = 'block';
                        break;
                        
                    case 'height':
                        if (heightControls) heightControls.style.display = 'block';
                        break;
                        
                    case 'angle':
                        if (cameraControls) cameraControls.style.display = 'block';
                        break;
                        
                    default:
                        console.warn('‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å:', mode);
                        break;
                }
                
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                const stepsDiv = document.getElementById('calculationSteps');
                if (stepsDiv) {
                    stepsDiv.classList.remove('show');
                }
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                updateResults(0, 0, 0, 0);
                
                console.log('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏õ‡πá‡∏ô:', currentMode);
                
            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î:', error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î: ${error.message}\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
            } finally {
                // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 500ms
                setTimeout(() => {
                    modeChangeInProgress = false;
                }, 500);
            }
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î
        function addPoint(x = null, y = null) {
            if (!cameraActive) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }
            
            const container = document.querySelector('.camera-container');
            const rect = container.getBoundingClientRect();
            
            // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            if (x === null || y === null) {
                x = rect.width / 2;
                y = rect.height / 2;
            }

            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏ü‡∏£‡∏° ‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å
            if (x < 0 || y < 0 || x > rect.width || y > rect.height) return;

            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
            if (currentMode === 'height' && points.length >= 2) {
                alert('‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 2 ‡∏à‡∏∏‡∏î (‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î)');
                return;
            }
            if (currentMode === 'distance' && points.length >= 2) {
                alert('‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô-‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)');
                return;
            }
            if (currentMode === 'angle' && points.length >= 3) {
                alert('‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏î‡∏°‡∏∏‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 3 ‡∏à‡∏∏‡∏î (‡∏¢‡∏≠‡∏î‡∏°‡∏∏‡∏°, ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1, ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2)');
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
            const point = {
                id: points.length,
                x: x,
                y: y
            };
            
            points.push(point);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const pointElement = document.createElement('div');
            pointElement.className = 'point';
            pointElement.style.left = x + 'px';
            pointElement.style.top = y + 'px';
            pointElement.title = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${point.id + 1}`;
            
            document.getElementById('points').appendChild(pointElement);
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            updateInfo();
            drawLines();
        }
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function clearPoints() {
            points = [];
            document.getElementById('points').innerHTML = '';
            updateInfo();
            updateResults();
        }

        // ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        function undoPoint() {
            if (points.length === 0) return;
            points.pop();
            const pts = document.getElementById('points');
            if (pts.lastChild) pts.removeChild(pts.lastChild);
            updateInfo();
            drawLines();
        }
        
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î
        function drawLines() {
            // ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏Å‡πà‡∏≤
            document.querySelectorAll('.measurement-line').forEach(line => line.remove());
            
            if (points.length < 2) return;
            
            const container = document.getElementById('points');
            
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ô‡∏≤‡∏ö 2D
                const pixelDistance = Math.sqrt(dx * dx + dy * dy);
                
                // Advanced Perspective Correction
                const correctedDistance = applyAdvancedPerspectiveCorrection(p1, p2, pixelDistance);
                
                const line = document.createElement('div');
                line.className = 'measurement-line';
                
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.left = p1.x + 'px';
                line.style.top = p1.y + 'px';
                line.style.width = correctedDistance + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                
                container.appendChild(line);
            }
            
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            if (currentMode === 'area' && points.length > 2) {
                const p1 = points[points.length - 1];
                const p2 = points[0];
                
                const line = document.createElement('div');
                line.className = 'measurement-line';
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ô‡∏≤‡∏ö 2D
                const pixelDistance = Math.sqrt(dx * dx + dy * dy);
                
                // Advanced Perspective Correction
                const correctedDistance = applyAdvancedPerspectiveCorrection(p1, p2, pixelDistance);
                
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.left = p1.x + 'px';
                line.style.top = p1.y + 'px';
                line.style.width = correctedDistance + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                
                container.appendChild(line);
            }
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function calculate() {
            let distance = 0;
            let area = 0;
            let height = 0;
            let angle = 0;
            
            switch (currentMode) {
                case 'distance':
                    if (points.length === 0) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
                        return;
                    }
                    if (points.length >= 2) {
                        distance = calculateDistance();
                        showCalculationSteps('distance', distance);
                    }
                    break;
                    
                case 'area':
                    if (points.length === 0) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
                        return;
                    }
                    if (points.length >= 3) {
                        area = calculateArea();
                        showCalculationSteps('area', area);
                    } else {
                        alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
                        return;
                    }
                    break;
                    
                case 'height':
                    // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏ä‡πâ Law of Cosines - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
                    height = calculateHeightFromLawOfCosines();
                    if (height > 0) {
                        showCalculationSteps('height', height);
                    } else {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏° C ‡πÅ‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô a, b ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                        return;
                    }
                    break;
                    
                case 'angle':
                    if (points.length === 0) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
                        return;
                    }
                    if (points.length >= 3) {
                        angle = calculateAngle();
                        showCalculationSteps('angle', angle);
                    } else {
                        alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 3 ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏°‡∏∏‡∏°');
                        return;
                    }
                    break;
            }
            
            updateResults(distance, area, height, angle);
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        function getScalePxPerMeter() {
            const v = parseFloat(document.getElementById('scaleInput')?.value || '100');
            return isNaN(v) || v <= 0 ? 100 : v;
        }

        function calculateDistance() {
            let totalDistance = 0;
            const s = getScalePxPerMeter();
            
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ô‡∏≤‡∏ö 2D
                const pixelDistance = Math.sqrt(dx * dx + dy * dy);
                
                // Advanced Perspective Correction
                const correctedDistance = applyAdvancedPerspectiveCorrection(p1, p2, pixelDistance, s);
                totalDistance += correctedDistance;
            }
            
            return totalDistance;
        }
        
        // Advanced Perspective Correction System (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
        function applyAdvancedPerspectiveCorrection(p1, p2, pixelDistance, scale) {
            const centerX = video.videoWidth / 2;
            const centerY = video.videoHeight / 2;
            const avgX = (p1.x + p2.x) / 2;
            const avgY = (p1.y + p2.y) / 2;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà - ‡∏ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            const distanceFromCenter = Math.sqrt(
                Math.pow((avgX - centerX) / centerX, 2) + 
                Math.pow((avgY - centerY) / centerY, 2)
            );
            
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (< 0.3) ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å
            if (distanceFromCenter < 0.3) {
                const minimalCorrection = 1 + distanceFromCenter * 0.05; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏µ‡∏¢‡∏á 5%
                return (pixelDistance * minimalCorrection) / scale;
            }
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á
            
            // 1. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ FOV ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
            const adjustedFOV = {
                horizontal: cameraFOV.horizontal * 0.8, // ‡∏•‡∏î‡∏•‡∏á 20%
                vertical: cameraFOV.vertical * 0.8
            };
            
            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å FOV (‡πÉ‡∏ä‡πâ tangent ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
            const horizontalAngle = ((avgX - centerX) / centerX) * (adjustedFOV.horizontal / 2) * (Math.PI / 180);
            const verticalAngle = ((avgY - centerY) / centerY) * (adjustedFOV.vertical / 2) * (Math.PI / 180);
            
            // 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô‡∏Å‡∏ß‡πà‡∏≤
            const radialDistance = Math.sqrt(
                Math.pow((avgX - centerX) / centerX, 2) + 
                Math.pow((avgY - centerY) / centerY, 2)
            );
            
            // ‡∏•‡∏î‡∏Ñ‡πà‡∏≤ curvature factor ‡∏•‡∏á‡∏°‡∏≤‡∏Å
            const curvatureFactor = 1 + Math.pow(radialDistance, 1.2) * 0.15; // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 0.4 ‡πÄ‡∏õ‡πá‡∏ô 0.15
            
            // 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏•‡∏î‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö)
            const tiltCorrection = Math.abs(cameraTilt) > 10 ? 
                Math.cos(cameraTilt * Math.PI / 180) : 1.0; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡∏Å
            
            // 5. ‡∏•‡∏î‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡∏≠‡∏á Distance Scaling
            const estimatedDistance = calculateDistanceToObject(avgY, centerY);
            const distanceScaling = Math.max(0.8, Math.min(1.2, estimatedDistance / 3.0)); // ‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏à‡∏≤‡∏Å 0.5-2.0 ‡πÄ‡∏õ‡πá‡∏ô 0.8-1.2
            
            // 6. ‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô
            const finalCorrection = curvatureFactor * tiltCorrection * distanceScaling;
            
            return (pixelDistance * finalCorrection) / scale;
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        function calculateArea() {
            if (points.length < 3) return 0;
            
            // ‡πÉ‡∏ä‡πâ Shoelace formula
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].x * points[j].y;
                area -= points[j].x * points[i].y;
            }
            const s = getScalePxPerMeter();
            return Math.abs(area) / 2 / (s * s); // ‡∏ï‡∏£.‡∏°.
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡πÉ‡∏ä‡πâ‡∏°‡∏∏‡∏°‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
        function calculateHeight() {
            if (points.length < 2) return 0;
            
            const p1 = points[0]; // ‡∏à‡∏∏‡∏î‡∏ê‡∏≤‡∏ô (‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
            const p2 = points[points.length - 1]; // ‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
            const centerY = video.videoHeight / 2;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
            let avgDistance;
            if (manualDistanceMode) {
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                avgDistance = manualDistance;
            } else {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                avgDistance = (calculateDistanceToObject(p1.y, centerY) + calculateDistanceToObject(p2.y, centerY)) / 2;
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
            const pixelDifference = Math.abs(p2.y - p1.y);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•
            const verticalFOVRad = (cameraFOV.vertical * Math.PI) / 180;
            const pixelsPerDegree = video.videoHeight / verticalFOVRad;
            const angleInRadians = pixelDifference / pixelsPerDegree;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥: height = distance √ó tan(angle)
            let objectHeight = avgDistance * Math.tan(angleInRadians);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const dx = Math.abs(p2.x - p1.x);
            if (dx > 20) { // ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏°‡∏≤‡∏Å
                const horizontalCorrection = Math.cos(Math.atan(dx / video.videoWidth));
                objectHeight *= horizontalCorrection;
            }
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            const tiltCorrection = Math.cos(cameraTilt * Math.PI / 180);
            objectHeight *= tiltCorrection;
            
            // ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
            if (!manualDistanceMode) {
                const distanceCompensation = getDistanceCompensationFactor(avgDistance, objectHeight);
                objectHeight *= distanceCompensation;
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
            const calibrationFactor = 1.2; // ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á
            objectHeight *= calibrationFactor;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
            if (!manualDistanceMode) {
                const distanceCheck = checkOptimalDistance(objectHeight, avgDistance);
                updateDistanceWarnings(distanceCheck);
            }
            
            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
            return Math.max(0.1, Math.min(100, objectHeight));
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏• (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)
        function getVerticalAngleFromPixel(pixelY, centerY) {
            // ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å: ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô (‡∏°‡∏∏‡∏° = 0¬∞)
            if (perpendicularMode) {
                return 0;
            }
            
            // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
            const normalizedY = (pixelY - centerY) / centerY;
            const verticalAngleRad = normalizedY * (cameraFOV.vertical / 2) * (Math.PI / 180);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            return verticalAngleRad + (cameraTilt * Math.PI / 180);
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•
        function getHorizontalAngleFromPixel(pixelX, centerX) {
            const normalizedX = (pixelX - centerX) / centerX;
            const halfFOVRad = (cameraFOV.horizontal / 2) * (Math.PI / 180);
            return Math.atan(normalizedX * Math.tan(halfFOVRad));
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°
        function calculateAngle() {
            if (points.length < 3) return 0;
            
            const vertex = points[0]; // ‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏∏‡∏°
            const p1 = points[1];     // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1
            const p2 = points[2];     // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
            const v1x = p1.x - vertex.x;
            const v1y = p1.y - vertex.y;
            const v2x = p2.x - vertex.x;
            const v2y = p2.y - vertex.y;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô atan2
            const angle1 = Math.atan2(v1y, v1x);
            const angle2 = Math.atan2(v2y, v2x);
            
            // ‡∏´‡∏≤‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á
            let angleDiff = Math.abs(angle2 - angle1);
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤
            angleDiff = angleDiff * (180 / Math.PI);
            
            // ‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 0-180 ‡∏≠‡∏á‡∏®‡∏≤
            if (angleDiff > 180) {
                angleDiff = 360 - angleDiff;
            }
            
            return angleDiff;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        function showCalculationSteps(mode, result) {
            const stepsDiv = document.getElementById('calculationSteps');
            const contentDiv = document.getElementById('stepsContent');
            const s = getScalePxPerMeter();
            
            let stepsHTML = '';
            
            switch(mode) {
                case 'distance':
                    if (points.length >= 2) {
                        const p1 = points[0];
                        const p2 = points[1];
                        const dx = p2.x - p1.x;
                        const dy = p2.y - p1.y;
                        const pixelDistance = Math.sqrt(dx * dx + dy * dy);
                        
                        const centerY = video.videoHeight / 2;
                        const avgY = (p1.y + p2.y) / 2;
                        const distanceFromCenter = Math.abs(avgY - centerY);
                        const perspectiveFactor = 1 + (distanceFromCenter / centerY) * 0.3;
                        const depthFactor = avgY > centerY ? 1 + ((avgY - centerY) / centerY) * 0.5 : 1;
                        
                        const centerX = video.videoWidth / 2;
                        const avgX = (p1.x + p2.x) / 2;
                        const avgYPos = (p1.y + p2.y) / 2;
                        const estimatedDistance = calculateDistanceToObject(avgYPos, centerY);
                        const radialDistance = Math.sqrt(
                            Math.pow((avgX - centerX) / centerX, 2) + 
                            Math.pow((avgYPos - centerY) / centerY, 2)
                        );
                        const curvatureFactor = 1 + Math.pow(radialDistance, 1.5) * 0.4;
                        const tiltCorrection = Math.cos(cameraTilt * Math.PI / 180);
                        const distanceScaling = Math.max(0.5, Math.min(2.0, estimatedDistance / 3.0));
                        
                        stepsHTML = `
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1:</span> ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ô‡∏≤‡∏ö 2D
                                <div class="step-formula">Œîx = ${dx} px, Œîy = ${dy} px</div>
                                <div class="step-formula">d‚ÇÇD = ‚àö(Œîx¬≤ + Œîy¬≤) = ${pixelDistance.toFixed(2)} px</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2:</span> Advanced Perspective Correction
                                <div class="step-formula">FOV: H=${cameraFOV.horizontal}¬∞, V=${cameraFOV.vertical}¬∞</div>
                                <div class="step-formula">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì = ${estimatedDistance.toFixed(2)} ‡∏°.</div>
                                <div class="step-formula">‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÇ‡∏Ñ‡πâ‡∏á = ${curvatureFactor.toFixed(3)}</div>
                                <div class="step-formula">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á = ${tiltCorrection.toFixed(3)} (${cameraTilt.toFixed(1)}¬∞)</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3:</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á
                                <div class="step-formula">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏ß‡∏° = ${(curvatureFactor * tiltCorrection * distanceScaling).toFixed(3)}</div>
                                <div class="step-formula">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á = (${pixelDistance.toFixed(2)} √ó ${(curvatureFactor * tiltCorrection * distanceScaling).toFixed(3)}) √∑ ${s} = ${result.toFixed(3)} ‡∏°.</div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'height':
                    if (result > 0) {
                        const angleC = parseFloat(document.getElementById('angleInput')?.value || '90');
                        const sideA = parseFloat(document.getElementById('sideAInput')?.value || '3.0');
                        const sideB = parseFloat(document.getElementById('sideBInput')?.value || '4.0');
                        const angleCRad = (angleC * Math.PI) / 180;
                        const cSquared = (sideA * sideA) + (sideB * sideB) - (2 * sideA * sideB * Math.cos(angleCRad));
                        
                        stepsHTML = `
                            <div class="step-item">
                                <span class="step-number">üìê Law of Cosines:</span> ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
                                <div class="step-formula"><strong>‡∏™‡∏π‡∏ï‡∏£:</strong> c¬≤ = a¬≤ + b¬≤ - 2ab cos(C)</div>
                                <div class="step-formula"><strong>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô:</strong> ‡∏°‡∏∏‡∏° C = ${angleC}¬∞, ‡∏î‡πâ‡∏≤‡∏ô a = ${sideA} ‡∏°., ‡∏î‡πâ‡∏≤‡∏ô b = ${sideB} ‡∏°.</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1:</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì cos(${angleC}¬∞)
                                <div class="step-formula">cos(${angleC}¬∞) = ${Math.cos(angleCRad).toFixed(6)}</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2:</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏π‡∏ï‡∏£
                                <div class="step-formula">a¬≤ = ${sideA}¬≤ = ${(sideA * sideA).toFixed(3)}</div>
                                <div class="step-formula">b¬≤ = ${sideB}¬≤ = ${(sideB * sideB).toFixed(3)}</div>
                                <div class="step-formula">2ab cos(C) = 2 √ó ${sideA} √ó ${sideB} √ó ${Math.cos(angleCRad).toFixed(6)} = ${(2 * sideA * sideB * Math.cos(angleCRad)).toFixed(6)}</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3:</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì c¬≤
                                <div class="step-formula">c¬≤ = ${(sideA * sideA).toFixed(3)} + ${(sideB * sideB).toFixed(3)} - ${(2 * sideA * sideB * Math.cos(angleCRad)).toFixed(6)}</div>
                                <div class="step-result">c¬≤ = ${cSquared.toFixed(6)}</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4:</span> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
                                <div class="step-result">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (c) = ‚àö${cSquared.toFixed(6)} = <strong>${result.toFixed(3)} ‡πÄ‡∏°‡∏ï‡∏£</strong></div>
                                ${cSquared < 0 ? '<div style="color: #ff4757; font-weight: bold;">‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°</div>' : ''}
                            </div>
                        `;
                    }
                    break;
                    
                case 'angle':
                    if (points.length >= 3) {
                        const vertex = points[0]; // ‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏∏‡∏°
                        const p1 = points[1];     // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1
                        const p2 = points[2];     // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2
                        
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
                        const v1x = p1.x - vertex.x;
                        const v1y = p1.y - vertex.y;
                        const v2x = p2.x - vertex.x;
                        const v2y = p2.y - vertex.y;
                        
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô atan2
                        const angle1 = Math.atan2(v1y, v1x);
                        const angle2 = Math.atan2(v2y, v2x);
                        
                        // ‡∏´‡∏≤‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á
                        let angleDiff = Math.abs(angle2 - angle1);
                        
                        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤
                        angleDiff = angleDiff * (180 / Math.PI);
                        
                        // ‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 0-180 ‡∏≠‡∏á‡∏®‡∏≤
                        if (angleDiff > 180) {
                            angleDiff = 360 - angleDiff;
                        }
                        
                        stepsHTML = `
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1:</span> ‡∏´‡∏≤‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏°‡∏∏‡∏°
                                <div class="step-formula">‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå 1: (${v1x}, ${v1y})</div>
                                <div class="step-formula">‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå 2: (${v2x}, ${v2y})</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2:</span> ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô arctan
                                <div class="step-formula">Œ∏‚ÇÅ = arctan(${v1y}/${v1x})</div>
                                <div class="step-formula">Œ∏‚ÇÇ = arctan(${v2y}/${v2x})</div>
                            </div>
                            <div class="step-item">
                                <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3:</span> ‡∏´‡∏≤‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå
                                <div class="step-formula">‡∏°‡∏∏‡∏° = |Œ∏‚ÇÇ - Œ∏‚ÇÅ|</div>
                                <div class="step-result">‡∏°‡∏∏‡∏° = ${result.toFixed(2)}¬∞</div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'area':
                    stepsHTML = `
                        <div class="step-item">
                            <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1:</span> ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£ Shoelace Formula
                            <div class="step-formula">Area = ¬Ω|‚àë(x·µ¢y·µ¢‚Çä‚ÇÅ - x·µ¢‚Çä‚ÇÅy·µ¢)|</div>
                        </div>
                        <div class="step-item">
                            <span class="step-number">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2:</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${points.length} ‡∏à‡∏∏‡∏î
                            <div class="step-result">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà = ${result.toFixed(2)} ‡∏ï‡∏£.‡∏°.</div>
                        </div>
                    `;
                    break;
            }
            
            contentDiv.innerHTML = stepsHTML;
            stepsDiv.classList.add('show');
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î
        function updateInfo() {
            const info = document.getElementById('info');
            const tiltText = Math.abs(cameraTilt) > 5 ? 
                ` | ‡πÄ‡∏≠‡∏µ‡∏¢‡∏á: ${cameraTilt.toFixed(1)}¬∞` : '';
            
            if (currentMode === 'height' && points.length >= 1) {
                const centerY = video.videoHeight / 2;
                const lastPoint = points[points.length - 1];
                const distanceToObject = calculateDistanceToObject(lastPoint.y, centerY);
                info.textContent = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: ${points.length} | ‡∏£‡∏∞‡∏¢‡∏∞: ${distanceToObject.toFixed(1)}‡∏°.${tiltText}`;
            } else {
                info.textContent = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î: ${points.length}${tiltText}`;
            }
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function updateResults(distance = 0, area = 0, height = 0, angle = 0) {
            const distanceEl = document.getElementById('distance');
            const areaEl = document.getElementById('area');
            const heightEl = document.getElementById('height');
            const angleEl = document.getElementById('angle');
            const pointCountEl = document.getElementById('point-count');
            
            if (distanceEl) distanceEl.textContent = distance.toFixed(2) + ' ‡∏°.';
            if (areaEl) areaEl.textContent = area.toFixed(2) + ' ‡∏ï‡∏£.‡∏°.';
            if (heightEl) heightEl.textContent = height.toFixed(2) + ' ‡∏°.';
            if (angleEl) angleEl.textContent = angle.toFixed(1) + '¬∞';
            if (pointCountEl) pointCountEl.textContent = points.length;
            
            // Only show object distance for non-height modes or when in height mode with points
            const objectDistanceEl = document.getElementById('object-distance');
            if (objectDistanceEl) {
                if (currentMode !== 'height') {
                    if (points.length >= 2) {
                        const centerY = video.videoHeight / 2;
                        const p1 = points[0];
                        const p2 = points[points.length - 1];
                        const baseDistance = calculateDistanceToObject(p1.y, centerY);
                        const topDistance = calculateDistanceToObject(p2.y, centerY);
                        const avgDistance = (baseDistance + topDistance) / 2;
                        objectDistanceEl.textContent = avgDistance.toFixed(1) + ' ‡∏°.';
                    } else {
                        objectDistanceEl.textContent = '0 ‡∏°.';
                    }
                } else {
                    // For height mode with Law of Cosines, show the calculated height
                    objectDistanceEl.textContent = height > 0 ? height.toFixed(2) + ' ‡∏°.' : '0 ‡∏°.';
                }
            }
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞
        function checkCameraStatus() {
            if (stream) {
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack && videoTrack.readyState === 'ended') {
                    console.log('‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å');
                    cameraActive = false;
                    const statusElement = document.getElementById('camera-status');
                    statusElement.style.display = 'block';
                    statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                    statusElement.style.color = '#ff4757';
                }
            }
        }
        
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        (function setupTapToAdd() {
            const container = document.querySelector('.camera-container');
            let lastAddTs = 0;
            function addPointFromEvent(e) {
                if (!cameraActive) return;
                const now = Date.now();
                if (now - lastAddTs < 250) return; // debounce 250ms
                const rect = container.getBoundingClientRect();
                let clientX, clientY;
                if (e.touches && e.touches.length) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                if (calibrationMode) {
                    handleCalibrationTap(x, y);
                } else {
                    addPoint(x, y);
                }
                lastAddTs = now;
            }
            container.addEventListener('click', addPointFromEvent);
            container.addEventListener('touchstart', function(e){ addPointFromEvent(e); }, { passive: true });
        })();
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        function checkOptimalDistance(estimatedHeight, currentDistance) {
            const warnings = [];
            const suggestions = [];
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
            const optimalDistance = Math.max(2, Math.min(estimatedHeight * 2, 15));
            
            if (currentDistance < 2) {
                warnings.push("‚ö†Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏ú‡∏•‡πÑ‡∏°‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥");
                suggestions.push(`üìè ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏¢‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô ${optimalDistance.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£`);
            } else if (currentDistance > 10 && estimatedHeight < 5) {
                warnings.push("‚ö†Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏µ‡πâ");
                suggestions.push(`üìè ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πá‡∏ô ${optimalDistance.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£`);
            } else if (estimatedHeight > 8 && currentDistance < estimatedHeight * 1.5) {
                warnings.push("‚ö†Ô∏è ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô");
                suggestions.push(`üìè ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏™‡∏π‡∏á ${estimatedHeight.toFixed(1)}‡∏°. ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏∞‡∏¢‡∏∞ ${optimalDistance.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£`);
            }
            
            return { warnings, suggestions, optimalDistance };
        }
        
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
        function getDistanceCompensationFactor(distance, objectHeight) {
            let compensationFactor = 1.0;
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏• (>10‡∏°.) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ä‡∏î‡πÄ‡∏ä‡∏¢
            if (distance > 10) {
                compensationFactor = 1.0 + (distance - 10) * 0.05; // ‡πÄ‡∏û‡∏¥‡πà‡∏° 5% ‡∏ó‡∏∏‡∏Å 1 ‡πÄ‡∏°‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10‡∏°.
            }
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (>8‡∏°.) ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            if (objectHeight > 8) {
                compensationFactor *= 1.0 + (objectHeight - 8) * 0.02; // ‡πÄ‡∏û‡∏¥‡πà‡∏° 2% ‡∏ó‡∏∏‡∏Å 1 ‡πÄ‡∏°‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 8‡∏°.
            }
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ (<3‡∏°.) ‡∏•‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢
            if (distance < 3) {
                compensationFactor *= 0.9 + distance * 0.033; // ‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ
            }
            
            return compensationFactor;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î
        function updateDistanceWarnings(distanceCheck) {
            const warningElement = document.getElementById('distance-warnings');
            if (!warningElement) return;
            
            let warningHTML = '';
            
            if (distanceCheck.warnings.length > 0 || distanceCheck.suggestions.length > 0) {
                warningHTML = '<div class="distance-warnings">';
                
                distanceCheck.warnings.forEach(warning => {
                    warningHTML += `<div class="warning-item">${warning}</div>`;
                });
                
                distanceCheck.suggestions.forEach(suggestion => {
                    warningHTML += `<div class="suggestion-item">${suggestion}</div>`;
                });
                
                warningHTML += '</div>';
            }
            
            warningElement.innerHTML = warningHTML;
        }
        
        // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï: ‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πÄ‡∏Å‡∏• px/‡∏°.
        function toggleCalibration() {
            calibrationMode = !calibrationMode;
            const btn = document.getElementById('calibBtn');
            const statusElement = document.getElementById('camera-status');
            if (calibrationMode) {
                calibrationPoints = [];
                removeCalibrationMarkers();
                btn.textContent = '‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï... (‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î)';
                statusElement.style.display = 'block';
                statusElement.textContent = 'üéØ ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï: ‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏';
                statusElement.style.color = '#2ed573';
            } else {
                btn.textContent = 'üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡πÄ‡∏Å‡∏•';
                if (!cameraActive) {
                    statusElement.style.display = 'block';
                    statusElement.textContent = 'üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                    statusElement.style.color = '#ffeb3b';
                } else {
                    statusElement.style.display = 'none';
                }
                removeCalibrationMarkers();
            }
        }
        
        // ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
        async function calibrateCameraFOV() {
            if (!stream || !video.videoWidth) return;
            
            try {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• FOV ‡∏à‡∏≤‡∏Å MediaStreamTrack
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    const capabilities = videoTrack.getCapabilities();
                    
                    // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì FOV ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞ focal length (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (settings.width && settings.height) {
                        const aspectRatio = settings.width / settings.height;
                        
                        // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì FOV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)
                        if (aspectRatio > 1.5) { // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
                            cameraFOV.horizontal = 65; // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 75
                            cameraFOV.vertical = 50;   // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 60
                        } else { // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
                            cameraFOV.horizontal = 55; // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 65
                            cameraFOV.vertical = 40;   // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 50
                        }
                        
                        console.log('FOV calibrated:', cameraFOV);
                    }
                }
            } catch (error) {
                console.log('FOV calibration failed, using defaults:', error);
            }
        }
        
        // ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        function autoCalibrate() {
            const options = [
                { name: "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï", width: 8.56, height: 5.398, unit: "‡∏ã‡∏°." },
                { name: "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4", width: 21, height: 29.7, unit: "‡∏ã‡∏°." },
                { name: "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 10 ‡∏ö‡∏≤‡∏ó", width: 2.6, height: 2.6, unit: "‡∏ã‡∏°." },
                { name: "‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ iPhone", width: 7.1, height: 14.7, unit: "‡∏ã‡∏°." },
                { name: "‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤", width: 1.4, height: 14, unit: "‡∏ã‡∏°." }
            ];
            
            let optionText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏†‡∏≤‡∏û:\n";
            options.forEach((opt, i) => {
                optionText += `${i + 1}. ${opt.name} (${opt.width}√ó${opt.height} ${opt.unit})\n`;
            });
            
            const choice = prompt(optionText + "\n‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç 1-5:");
            const selectedIndex = parseInt(choice) - 1;
            
            if (selectedIndex >= 0 && selectedIndex < options.length) {
                const selected = options[selectedIndex];
                alert(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${selected.name}\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ: ‡∏ß‡∏≤‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏`);
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©
                calibrationMode = true;
                calibrationPoints = [];
                window.calibrationReference = selected;
                
                const statusElement = document.getElementById('camera-status');
                statusElement.style.display = 'block';
                statusElement.textContent = `üéØ ‡πÅ‡∏ï‡∏∞ 2 ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á${selected.name} (${selected.width} ${selected.unit})`;
                statusElement.style.color = '#2ed573';
            }
        }

        function handleCalibrationTap(x, y) {
            const container = document.querySelector('.camera-container');
            const rect = container.getBoundingClientRect();
            if (x < 0 || y < 0 || x > rect.width || y > rect.height) return;

            // ‡∏ß‡∏≤‡∏î marker ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            const marker = document.createElement('div');
            marker.className = 'calib-point';
            marker.style.position = 'absolute';
            marker.style.width = '10px';
            marker.style.height = '10px';
            marker.style.borderRadius = '50%';
            marker.style.background = '#2ed573';
            marker.style.border = '2px solid #145a32';
            marker.style.left = (x - 5) + 'px';
            marker.style.top = (y - 5) + 'px';
            document.getElementById('points').appendChild(marker);

            calibrationPoints.push({ x, y });
            if (calibrationPoints.length === 2) {
                const [p1, p2] = calibrationPoints;
                const pixelDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
                
                let realMeters;
                if (window.calibrationReference) {
                    // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
                    const ref = window.calibrationReference;
                    realMeters = ref.width / 100; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏ã‡∏°. ‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏°‡∏ï‡∏£
                    alert(`‡πÉ‡∏ä‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á${ref.name}: ${ref.width} ${ref.unit} = ${realMeters} ‡πÄ‡∏°‡∏ï‡∏£`);
                } else {
                    // ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
                    const realMetersStr = prompt(`‡∏£‡∏∞‡∏¢‡∏∞‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏• ‚âà ${pixelDist.toFixed(2)} px\n‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£):`, '1');
                    realMeters = parseFloat(realMetersStr);
                }
                
                if (!isNaN(realMeters) && realMeters > 0) {
                    const scale = pixelDist / realMeters; // px ‡∏ï‡πà‡∏≠ 1 ‡πÄ‡∏°‡∏ï‡∏£
                    const scaleInput = document.getElementById('scaleInput');
                    scaleInput.value = Math.max(1, Math.round(scale));
                    try { localStorage.setItem('scalePxPerMeter', scaleInput.value); } catch {}
                    updateRuler();
                    alert(`‚úÖ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏™‡πÄ‡∏Å‡∏•‡πÉ‡∏´‡∏°‡πà: ${scaleInput.value} px/‡∏°.\n‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏à‡∏∞‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô`);
                } else {
                    alert('‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï');
                }
                
                // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á marker
                calibrationMode = false;
                window.calibrationReference = null;
                const btn = document.getElementById('calibBtn');
                btn.textContent = 'üéØ ‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏™‡πÄ‡∏Å‡∏•';
                const statusElement = document.getElementById('camera-status');
                statusElement.style.display = 'none';
                removeCalibrationMarkers();
            }
        }

        function removeCalibrationMarkers() {
            calibrationPoints = [];
            document.querySelectorAll('.calib-point').forEach(el => el.remove());
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πÄ‡∏Å‡∏•‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á
        function updateRuler() {
            const bar = document.getElementById('rulerBar');
            const label = document.getElementById('rulerLabel');
            const container = document.querySelector('.camera-container');
            if (!bar || !label || !container) return;
            const rect = container.getBoundingClientRect();
            const scaleInput = document.getElementById('scaleInput');
            const pxPerMeter = Math.max(1, parseFloat(scaleInput.value) || 100);

            // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß = 1 ‡πÄ‡∏°‡∏ï‡∏£ ‡∏´‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏≠)
            const maxBar = Math.max(80, Math.min(rect.width - 40, 240));
            const targetWidth = pxPerMeter; // 1 ‡πÄ‡∏°‡∏ï‡∏£
            const barWidth = Math.round(Math.max(80, Math.min(targetWidth, maxBar)));
            bar.style.width = barWidth + 'px';
            label.textContent = `‡∏™‡πÄ‡∏Å‡∏•: 1 ‡∏°. ‚âà ${pxPerMeter} px` + (barWidth < pxPerMeter ? ' (‡πÅ‡∏™‡∏î‡∏á‡∏¢‡πà‡∏≠)' : '');

            // ‡∏•‡∏ö tick ‡πÄ‡∏î‡∏¥‡∏°
            bar.querySelectorAll('.tick, .tick-label').forEach(el => el.remove());

            // ‡∏ß‡∏≤‡∏î tick ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏Å‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏≠
            const maxMetersShown = barWidth / pxPerMeter; // ‡πÄ‡∏°‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ô‡πÅ‡∏ñ‡∏ö
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å step ‡∏¢‡πà‡∏≠‡∏¢
            let minorStep = 0.5; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0.5 ‡∏°.
            if (pxPerMeter * 0.5 < 40) {
                // ‡∏ñ‡πâ‡∏≤ 0.5 ‡πÄ‡∏°‡∏ï‡∏£‡πÅ‡∏Ñ‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏•‡∏±‡∏Å 1 ‡πÄ‡∏°‡∏ï‡∏£
                minorStep = 1;
            } else if (pxPerMeter * 0.25 >= 40 && maxMetersShown >= 1) {
                // ‡∏ñ‡πâ‡∏≤‡∏û‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏™‡∏î‡∏á 0.25 ‡∏î‡πâ‡∏ß‡∏¢
                minorStep = 0.25;
            }

            // ‡∏ß‡∏≤‡∏î‡∏à‡∏≤‡∏Å 0 ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ
            const endMeters = Math.max(minorStep, Math.min(1, maxMetersShown));
            for (let m = minorStep; m <= endMeters + 1e-6; m += minorStep) {
                const x = Math.round(m * pxPerMeter);
                if (x > barWidth) break;
                const isMajor = Math.abs(m - Math.round(m)) < 1e-6; // ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏°‡∏ï‡∏£
                const isHalf = Math.abs(m - 0.5) < 1e-6; // 0.5 ‡πÄ‡∏°‡∏ï‡∏£‡πÅ‡∏£‡∏Å

                const tick = document.createElement('div');
                tick.className = 'tick ' + (isMajor ? 'major' : 'minor');
                tick.style.left = x + 'px';
                bar.appendChild(tick);

                // ‡πÅ‡∏™‡∏î‡∏á label ‡∏ó‡∏µ‡πà 0.5 ‡∏°. ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏°.
                if (isMajor || isHalf) {
                    const lbl = document.createElement('div');
                    lbl.className = 'tick-label';
                    lbl.style.left = x + 'px';
                    lbl.textContent = (isHalf ? '0.5 ‡∏°.' : `${Math.round(m)} ‡∏°.`);
                    bar.appendChild(lbl);
                }
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á autoplay block ‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™)
        window.addEventListener('load', () => {
            console.log('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á');
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            const statusElement = document.getElementById('camera-status');
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            setMode('distance');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(checkCameraStatus, 2000);
            
            // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(() => {
                    console.log('Service Worker registered');
                }).catch(err => console.log('SW registration failed', err));
            }

            // Restore/Save scale from localStorage
            const scaleInput = document.getElementById('scaleInput');
            try {
                const saved = localStorage.getItem('scalePxPerMeter');
                if (saved) scaleInput.value = saved;
            } catch {}
            updateRuler();
            scaleInput.addEventListener('input', () => {
                try { localStorage.setItem('scalePxPerMeter', scaleInput.value); } catch {}
                updateRuler();
            });
            window.addEventListener('resize', () => {
                updateRuler();
            });
            
            console.log('‡πÅ‡∏≠‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function populateCameraSelect() {
            const select = document.getElementById('cameraSelect');
            if (!select) return;
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                select.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `‡∏Å‡∏•‡πâ‡∏≠‡∏á ${index + 1}`;
                    select.appendChild(option);
                });
                
                if (videoDevices.length > 1) {
                    document.getElementById('refreshBtn').style.display = 'inline-block';
                }
            } catch (error) {
                console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ:', error);
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function onCameraChange(deviceId) {
            if (deviceId && cameraActive) {
                await initCamera(deviceId);
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á
        async function refreshCameras() {
            await populateCameraSelect();
            alert('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà - ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô)
        function calculateDistanceToObject(pixelY, centerY) {
            // ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å: ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô (‡∏°‡∏∏‡∏° = 0¬∞)
            if (perpendicularMode) {
                // ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô: ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á = ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á / tan(0¬∞) = ‡πÑ‡∏°‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô)
                const baseDistance = cameraHeight * 2.0; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
                return Math.max(1.0, Math.min(20, baseDistance));
            }
            
            // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
            const normalizedY = (pixelY - centerY) / centerY;
            const verticalAngleRad = normalizedY * (cameraFOV.vertical / 2) * (Math.PI / 180);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            const adjustedAngle = verticalAngleRad + (cameraTilt * Math.PI / 180);
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏∏‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏≠‡∏á‡∏®‡∏≤ (‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô)
            if (Math.abs(adjustedAngle) < 0.05) {
                return cameraHeight / Math.tan(0.05); // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 30 ‡πÄ‡∏°‡∏ï‡∏£
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥
            const distance = Math.abs(cameraHeight / Math.tan(adjustedAngle));
            
            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏• (0.5-50 ‡πÄ‡∏°‡∏ï‡∏£)
            return Math.max(0.5, Math.min(50, distance));
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        function calculateArea() {
            if (points.length < 3) return 0;
            
            // ‡πÉ‡∏ä‡πâ Shoelace formula
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += points[i].x * points[j].y;
                area -= points[j].x * points[i].y;
            }
            const s = getScalePxPerMeter();
            return Math.abs(area) / 2 / (s * s); // ‡∏ï‡∏£.‡∏°.
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡πÉ‡∏ä‡πâ‡∏°‡∏∏‡∏°‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
        function calculateHeight() {
            if (points.length < 2) return 0;
            
            const p1 = points[0]; // ‡∏à‡∏∏‡∏î‡∏ê‡∏≤‡∏ô (‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
            const p2 = points[points.length - 1]; // ‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
            const centerY = video.videoHeight / 2;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
            let avgDistance;
            if (manualDistanceMode) {
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                avgDistance = manualDistance;
            } else {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                avgDistance = (calculateDistanceToObject(p1.y, centerY) + calculateDistanceToObject(p2.y, centerY)) / 2;
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á
            const pixelDifference = Math.abs(p2.y - p1.y);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•
            const verticalFOVRad = (cameraFOV.vertical * Math.PI) / 180;
            const pixelsPerDegree = video.videoHeight / verticalFOVRad;
            const angleInRadians = pixelDifference / pixelsPerDegree;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥: height = distance √ó tan(angle)
            let objectHeight = avgDistance * Math.tan(angleInRadians);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const dx = Math.abs(p2.x - p1.x);
            if (dx > 20) { // ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏°‡∏≤‡∏Å
                const horizontalCorrection = Math.cos(Math.atan(dx / video.videoWidth));
                objectHeight *= horizontalCorrection;
            }
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            const tiltCorrection = Math.cos(cameraTilt * Math.PI / 180);
            objectHeight *= tiltCorrection;
            
            // ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
            if (!manualDistanceMode) {
                const distanceCompensation = getDistanceCompensationFactor(avgDistance, objectHeight);
                objectHeight *= distanceCompensation;
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)
            const calibrationFactor = 1.2; // ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á
            objectHeight *= calibrationFactor;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
            if (!manualDistanceMode) {
                const distanceCheck = checkOptimalDistance(objectHeight, avgDistance);
                updateDistanceWarnings(distanceCheck);
            }
            
            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
            return Math.max(0.1, Math.min(100, objectHeight));
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏• (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)
        function getVerticalAngleFromPixel(pixelY, centerY) {
            // ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å: ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô (‡∏°‡∏∏‡∏° = 0¬∞)
            if (perpendicularMode) {
                return 0;
            }
            
            // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
            const normalizedY = (pixelY - centerY) / centerY;
            const verticalAngleRad = normalizedY * (cameraFOV.vertical / 2) * (Math.PI / 180);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
            return verticalAngleRad + (cameraTilt * Math.PI / 180);
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•
        function getHorizontalAngleFromPixel(pixelX, centerX) {
            const normalizedX = (pixelX - centerX) / centerX;
            const halfFOVRad = (cameraFOV.horizontal / 2) * (Math.PI / 180);
            return Math.atan(normalizedX * Math.tan(halfFOVRad));
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°
        function calculateAngle() {
            if (points.length < 3) return 0;
            
            const vertex = points[0]; // ‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏∏‡∏°
            const p1 = points[1];     // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1
            const p2 = points[2];     // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
            const v1x = p1.x - vertex.x;
            const v1y = p1.y - vertex.y;
            const v2x = p2.x - vertex.x;
            const v2y = p2.y - vertex.y;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô atan2
            const angle1 = Math.atan2(v1y, v1x);
            const angle2 = Math.atan2(v2y, v2x);
            
            // ‡∏´‡∏≤‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á
            let angleDiff = Math.abs(angle2 - angle1);
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤
            angleDiff = angleDiff * (180 / Math.PI);
            
            // ‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 0-180 ‡∏≠‡∏á‡∏®‡∏≤
            if (angleDiff > 180) {
                angleDiff = 360 - angleDiff;
            }
            
            return angleDiff;
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏≠‡∏á
        function toggleManualDistance() {
            manualDistanceMode = !manualDistanceMode;
            const toggleButton = document.getElementById('manualDistanceToggle');
            const distanceField = document.getElementById('manualDistanceField');
            
            if (manualDistanceMode) {
                toggleButton.textContent = 'üìê ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á';
                toggleButton.style.backgroundColor = '#ff6b6b';
                distanceField.style.display = 'block';
            } else {
                toggleButton.style.backgroundColor = '#4ecdc4';
                distanceField.style.display = 'none';
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            updateInfo();
            if (points.length >= 2 && currentMode === 'height') {
                updateCalculationSteps();
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        function updateManualDistance(value) {
            manualDistance = parseFloat(value) || 5.0;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            updateInfo();
            if (points.length >= 2 && currentMode === 'height') {
                updateCalculationSteps();
            }
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏î‡πâ‡∏ß‡∏¢ Law of Cosines (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
        function calculateHeightFromLawOfCosines() {
            const angleC = parseFloat(document.getElementById('angleInput')?.value || '90');
            const sideA = parseFloat(document.getElementById('sideAInput')?.value || '3.0');
            const sideB = parseFloat(document.getElementById('sideBInput')?.value || '4.0');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤
            if (isNaN(angleC) || isNaN(sideA) || isNaN(sideB)) {
                return 0;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (angleC <= 0 || angleC >= 180 || sideA <= 0 || sideB <= 0) {
                return 0;
            }
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏∏‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ô
            const angleCRad = (angleC * Math.PI) / 180;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏ß‡∏¢ Law of Cosines: c¬≤ = a¬≤ + b¬≤ - 2ab cos(C)
            const cSquared = (sideA * sideA) + (sideB * sideB) - (2 * sideA * sideB * Math.cos(angleCRad));
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å (‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ)
            if (cSquared < 0) {
                return 0; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÑ‡∏î‡πâ
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á c
            const height = Math.sqrt(cSquared);
            
            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏• (0.01-1000 ‡πÄ‡∏°‡∏ï‡∏£)
            const finalHeight = Math.max(0.01, Math.min(1000, height));
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
            updateResults(0, 0, finalHeight, 0);
            
            return finalHeight;
        }
    </script>
</body>
</html>
